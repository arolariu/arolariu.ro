{
  "$schema": "https://schema.postman.com/collection/json/v2.1.0/draft-04/collection.json",
  "info": {
    "name": "api.arolariu.ro",
    "description": "Complete E2E test collection for the arolariu.ro backend API. Covers all Invoice and Merchant endpoints.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Collection-level test: RESTful status code validation",
          "pm.test(\"Response status follows RESTful conventions\", function () {",
          "    var requestName = pm.info.requestName;",
          "    // Skip for requests that expect specific non-2xx responses",
          "    if (requestName.includes('15 - Get Invoice Merchant (None)')) {",
          "        pm.expect(pm.response.code).to.eql(404, 'Expected 404 for no merchant');",
          "        return;",
          "    }",
          "    var method = pm.request.method.toUpperCase();",
          "    var code = pm.response.code;",
          "    var expectedRange;",
          "    if (method === 'GET' || method === 'HEAD') { expectedRange = [200, 299]; }",
          "    else if (method === 'POST') { expectedRange = [200, 299]; }",
          "    else if (method === 'PUT' || method === 'PATCH') { expectedRange = [200, 299]; }",
          "    else if (method === 'DELETE') { expectedRange = [200, 299]; }",
          "    else { expectedRange = [200, 399]; }",
          "    pm.expect(code).to.be.within(expectedRange[0], expectedRange[1],",
          "        `Expected ${method} request to return ${expectedRange[0]}-${expectedRange[1]}, got ${code}`);",
          "});",
          "",
          "// Collection-level test: Performance SLA (<2000ms for analysis, <1000ms otherwise)",
          "pm.test(\"Response time is acceptable\", function () {",
          "    var requestName = pm.info.requestName.toLowerCase();",
          "    var threshold = requestName.includes('01') ? 30000 : 3000;",
          "    pm.expect(pm.response.responseTime).to.be.below(threshold,",
          "        `Response time ${pm.response.responseTime}ms exceeds ${threshold}ms threshold`);",
          "});",
          "",
          "// Collection-level test: Content-Type header validation",
          "pm.test(\"Content-Type header is present and valid\", function () {",
          "    var requestName = pm.info.requestName;",
          "    // Skip for requests that expect 404 with no body",
          "    if (requestName.includes('15 - Get Invoice Merchant (None)')) {",
          "        return; // 404 may not have content-type",
          "    }",
          "    var contentType = pm.response.headers.get('Content-Type');",
          "    if (pm.response.code !== 204) {",
          "        pm.expect(contentType).to.exist;",
          "        pm.expect(contentType).to.match(/application\\/json|text\\/plain|text\\/html/,",
          "            `Invalid Content-Type: ${contentType}`);",
          "    }",
          "});",
          "",
          "// Collection-level test: Response body validation (skip for 204)",
          "pm.test(\"Response body is valid\", function () {",
          "    var requestName = pm.info.requestName;",
          "    // Skip for requests that expect 404 with no body",
          "    if (requestName.includes('15 - Get Invoice Merchant (None)')) {",
          "        return; // 404 may have empty body",
          "    }",
          "    if (pm.response.code !== 204) {",
          "        pm.expect(pm.response.text()).to.have.length.greaterThan(0);",
          "    }",
          "});",
          "",
          "// Log detailed performance metrics for diagnostics",
          "console.log(`[${pm.info.requestName}] Status: ${pm.response.code} | Time: ${pm.response.responseTime}ms | Size: ${pm.response.responseSize} bytes`);"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Invoices",
      "description": "Invoice CRUD operations and sub-resource management",
      "item": [
        {
          "name": "01 - Get All Invoices (Empty)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Retrieve all invoices for the current user. Should be empty initially.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices"
              ]
            }
          }
        },
        {
          "name": "02 - Create Invoice",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Create a new invoice with an initial scan. Expected: 201 Created.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userIdentifier\": \"{{userIdentifier}}\",\n  \"initialScan\": {\n    \"type\": 2,\n    \"location\": \"https://cdn.arolariu.ro/invoices/test-receipt.png\",\n    \"metadata\": {\n      \"source\": \"postman-test\",\n      \"uploadedAt\": \"2025-01-17T12:00:00Z\"\n    }\n  },\n  \"metadata\": {\n    \"testRun\": \"true\",\n    \"author\": \"PostmanCollection\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Expected status 201 Created\", function () {",
                  "    pm.expect(pm.response.code).to.eql(201);",
                  "});",
                  "try {",
                  "    var body = pm.response.json();",
                  "    var id = body && (body.id || body.invoiceIdentifier || body.Id);",
                  "    if (id) {",
                  "        pm.collectionVariables.set('invoiceIdentifier', String(id));",
                  "        console.log('Stored invoiceIdentifier = ' + id);",
                  "    } else {",
                  "        console.warn('Create Invoice response did not include an id field. Response: ' + JSON.stringify(body));",
                  "    }",
                  "} catch (e) {",
                  "    console.warn('Could not parse response body: ' + e);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "03 - Get All Invoices (Has One)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Retrieve all invoices. Should now have at least one.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Response contains at least one invoice\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    pm.expect(body.length).to.be.greaterThan(0);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "04 - Get Specific Invoice",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Retrieve a single invoice by its identifier.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Invoice ID matches requested\", function () {",
                  "    var body = pm.response.json();",
                  "    var expectedId = pm.collectionVariables.get('invoiceIdentifier');",
                  "    var actualId = body.id || body.Id || body.invoiceIdentifier;",
                  "    pm.expect(String(actualId).toLowerCase()).to.eql(String(expectedId).toLowerCase());",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "05 - Update Invoice (PUT)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Full update of an invoice. Expected: 202 Accepted.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id\": \"{{invoiceIdentifier}}\",\n  \"userIdentifier\": \"{{userIdentifier}}\",\n  \"isImportant\": true,\n  \"name\": \"Updated Test Invoice\",\n  \"description\": \"This invoice was updated via PUT request\",\n  \"category\": 3,\n  \"paymentInformation\": {\n    \"transactionDate\": \"2025-01-17T15:30:00Z\",\n    \"paymentType\": 0,\n    \"currency\": {\n      \"name\": \"Romanian Leu\",\n      \"code\": \"RON\",\n      \"symbol\": \"lei\"\n    },\n    \"totalCostAmount\": 150.50,\n    \"totalTaxAmount\": 28.60\n  },\n  \"items\": [\n    {\n      \"rawName\": \"Test Product 1\",\n      \"genericName\": \"Test Product\",\n      \"category\": 1,\n      \"quantity\": 2,\n      \"quantityUnit\": \"buc\",\n      \"productCode\": \"PRD001\",\n      \"price\": 75.25,\n      \"metadata\": {\n        \"isEdited\": true,\n        \"isComplete\": true,\n        \"isSoftDeleted\": false\n      }\n    }\n  ],\n  \"additionalMetadata\": {\n    \"updatedVia\": \"PUT\",\n    \"updateTimestamp\": \"2025-01-17T15:30:00Z\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "06 - Patch Invoice",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Partial update of an invoice. Expected: 202 Accepted.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id\": \"{{invoiceIdentifier}}\",\n  \"userIdentifier\": \"{{userIdentifier}}\",\n  \"isImportant\": false,\n  \"name\": \"Patched Invoice Name\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "07 - Verify Patch Applied",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify the PATCH was applied correctly.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Invoice name was patched\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body.name).to.eql('Patched Invoice Name');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Invoice Products",
      "description": "Invoice product/item management",
      "item": [
        {
          "name": "08 - Get Invoice Products (Empty)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Get products from invoice. May have items from PUT.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            }
          }
        },
        {
          "name": "09 - Add Product to Invoice",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Add a new product to the invoice. Expected: 201 Created.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"rawName\": \"Mere Golden\",\n  \"genericName\": \"Apples\",\n  \"category\": 1,\n  \"quantity\": 5,\n  \"quantityUnit\": \"kg\",\n  \"productCode\": \"APL001\",\n  \"price\": 12.50,\n  \"totalPrice\": 62.50\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "10 - Get Invoice Products (Has Product)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify product was added.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Products list contains items\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    pm.expect(body.length).to.be.greaterThan(0);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "11 - Update Product in Invoice (PUT)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Update an existing product in the invoice.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"originalProductName\": \"Mere Golden\",\n  \"rawName\": \"Mere Golden\",\n  \"genericName\": \"Golden Apples - Updated\",\n  \"category\": 1,\n  \"quantity\": 10,\n  \"quantityUnit\": \"kg\",\n  \"productCode\": \"APL001\",\n  \"price\": 11.00\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "12 - Add Second Product",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Add a second product for testing deletion.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"rawName\": \"Lapte Zuzu\",\n  \"genericName\": \"Milk\",\n  \"category\": 2,\n  \"quantity\": 2,\n  \"quantityUnit\": \"L\",\n  \"productCode\": \"MLK001\",\n  \"price\": 8.99,\n  \"totalPrice\": 17.98\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "13 - Remove Product from Invoice",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Remove a product from the invoice by rawName.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productName\": \"Lapte Zuzu\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "14 - Verify Product Removed",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify the milk product was removed.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "products"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Milk product was removed\", function () {",
                  "    var body = pm.response.json();",
                  "    var milkProducts = body.filter(p => p.rawName === 'Lapte Zuzu');",
                  "    pm.expect(milkProducts.length).to.eql(0);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Invoice Merchant",
      "description": "Invoice-Merchant association management",
      "item": [
        {
          "name": "15 - Get Invoice Merchant (None)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Get the merchant associated with the invoice. Initially none - expects 404.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/merchant",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "merchant"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// Override collection-level tests for this 404 case",
                  "pm.test(\"Response status follows RESTful conventions\", function () {",
                  "    pm.expect(pm.response.code).to.eql(404, 'Expected 404 Not Found when no merchant is associated');",
                  "});",
                  "",
                  "pm.test(\"Content-Type header is present and valid\", function () {",
                  "    // 404 responses may not have content-type, which is acceptable",
                  "    pm.expect(true).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"Response body is valid\", function () {",
                  "    // 404 responses may have empty body, which is acceptable",
                  "    pm.expect(true).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "16 - Add Merchant to Invoice",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Associate a new merchant with the invoice. Expected: 201 Created.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/merchant",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "merchant"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Carrefour Hypermarket\",\n  \"description\": \"Large retail hypermarket chain\",\n  \"category\": 1,\n  \"address\": {\n    \"email\": \"contact@carrefour.ro\",\n    \"phone\": \"+40 21 123 4567\",\n    \"addressLine1\": \"Bulevardul Unirii 1\",\n    \"city\": \"Bucuresti\",\n    \"state\": \"Bucuresti\",\n    \"postalCode\": \"030167\",\n    \"country\": \"Romania\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Expected status 201 Created\", function () {",
                  "    pm.expect(pm.response.code).to.eql(201);",
                  "});",
                  "try {",
                  "    var body = pm.response.json();",
                  "    var id = body && (body.id || body.merchantIdentifier || body.Id);",
                  "    if (id) {",
                  "        pm.collectionVariables.set('merchantIdentifier', String(id));",
                  "        console.log('Stored merchantIdentifier = ' + id);",
                  "    }",
                  "} catch (e) {",
                  "    console.warn('Could not extract merchant ID: ' + e);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "17 - Get Invoice Merchant (Has One)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify merchant was associated with the invoice.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/merchant",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "merchant"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Merchant is associated\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.have.property('name');",
                  "    pm.expect(body.name).to.eql('Carrefour Hypermarket');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "18 - Remove Merchant from Invoice",
          "request": {
            "method": "DELETE",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Disassociate the merchant from the invoice.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/merchant",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "merchant"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Invoice Scans",
      "description": "Invoice scan/receipt image management",
      "item": [
        {
          "name": "19 - Get Invoice Scans",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Get all scans associated with the invoice. Should have the initial scan.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/scans",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "scans"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"At least one scan exists\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    pm.expect(body.length).to.be.greaterThan(0);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "20 - Add Scan to Invoice",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Add another scan to the invoice. Expected: 201 Created.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/scans",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "scans"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"type\": 3,\n  \"location\": \"https://cdn.arolariu.ro/invoices/test-receipt-page2.pdf\",\n  \"metadata\": {\n    \"page\": \"2\",\n    \"addedVia\": \"postman-test\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "21 - Get Invoice Scans (Has Two)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify second scan was added.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/scans",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "scans"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Two scans exist\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    pm.expect(body.length).to.be.greaterThan(1);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "22 - Delete Scan from Invoice",
          "request": {
            "method": "DELETE",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Delete a specific scan by its location field. Expected: 204 No Content.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/scans/https%3A%2F%2Fcdn.arolariu.ro%2Finvoices%2Ftest-receipt-page2.pdf",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "scans",
                "https%3A%2F%2Fcdn.arolariu.ro%2Finvoices%2Ftest-receipt-page2.pdf"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Invoice Metadata",
      "description": "Invoice additional metadata management",
      "item": [
        {
          "name": "23 - Get Invoice Metadata",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Get the additional metadata for the invoice.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/metadata",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "metadata"
              ]
            }
          }
        },
        {
          "name": "24 - Patch Invoice Metadata",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Add/update metadata keys. Expected: 202 Accepted.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/metadata",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "metadata"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"entries\": {\n    \"processedBy\": \"postman-collection\",\n    \"priority\": \"high\",\n    \"reviewStatus\": \"pending\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "25 - Get Invoice Metadata (Updated)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify metadata was updated.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/metadata",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "metadata"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Metadata contains new keys\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.have.property('processedBy');",
                  "    pm.expect(body.processedBy).to.eql('postman-collection');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "26 - Delete Invoice Metadata Keys",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Delete specific metadata keys. Expected: 204 No Content.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}/metadata",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}",
                "metadata"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"keys\": [\"reviewStatus\"]\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        }
      ]
    },
    {
      "name": "Merchants",
      "description": "Standalone Merchant CRUD operations",
      "item": [
        {
          "name": "27 - Get All Merchants",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Retrieve all merchants for a given parent company.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants?parentCompanyId=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants"
              ],
              "query": [
                {
                  "key": "parentCompanyId",
                  "value": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
                }
              ]
            }
          }
        },
        {
          "name": "28 - Create Merchant",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Create a new merchant. Expected: 201 Created.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Lidl Romania\",\n  \"description\": \"German discount supermarket chain\",\n  \"address\": \"Strada Exemplu 123, Bucuresti\",\n  \"parentCompanyIdentifier\": \"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Expected status 201 Created\", function () {",
                  "    pm.expect(pm.response.code).to.eql(201);",
                  "});",
                  "try {",
                  "    var body = pm.response.json();",
                  "    var id = body && (body.id || body.merchantIdentifier || body.Id);",
                  "    if (id) {",
                  "        pm.collectionVariables.set('merchantIdentifier', String(id));",
                  "        console.log('Stored merchantIdentifier = ' + id);",
                  "    }",
                  "} catch (e) {",
                  "    console.warn('Could not extract merchant ID: ' + e);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "29 - Get All Merchants (Has One)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify merchant was created.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants?parentCompanyId=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants"
              ],
              "query": [
                {
                  "key": "parentCompanyId",
                  "value": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"At least one merchant exists\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    pm.expect(body.length).to.be.greaterThan(0);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "30 - Get Specific Merchant",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Retrieve a specific merchant by ID.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}"
              ]
            }
          }
        },
        {
          "name": "31 - Update Merchant (PUT)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Full update of a merchant. Expected: 202 Accepted.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Lidl Romania - Updated\",\n  \"description\": \"German discount supermarket chain - Updated via PUT\",\n  \"category\": 1,\n  \"parentCompanyId\": \"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee\",\n  \"address\": {\n    \"email\": \"contact@lidl.ro\",\n    \"phone\": \"+40 21 987 6543\",\n    \"addressLine1\": \"Strada Noua 456\",\n    \"city\": \"Bucuresti\",\n    \"state\": \"Bucuresti\",\n    \"postalCode\": \"012345\",\n    \"country\": \"Romania\"\n  },\n  \"additionalMetadata\": {\n    \"updatedVia\": \"PUT\",\n    \"storeCount\": \"300+\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "32 - Get Merchant After Update",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify merchant was updated.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Merchant name was updated\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body.name).to.eql('Lidl Romania - Updated');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Merchant Invoices",
      "description": "Merchant-Invoice relationship management",
      "item": [
        {
          "name": "33 - Get Merchant Invoices",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Get all invoices associated with a merchant.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}",
                "invoices"
              ]
            }
          }
        },
        {
          "name": "34 - Add Invoice to Merchant",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Associate an invoice with the merchant.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}",
                "invoices"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"invoiceIdentifiers\": [\"{{invoiceIdentifier}}\"]\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        },
        {
          "name": "35 - Get Merchant Invoices (Has One)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify invoice was associated.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}",
                "invoices"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Merchant has at least one invoice\", function () {",
                  "    var body = pm.response.json();",
                  "    pm.expect(body).to.be.an('array');",
                  "    pm.expect(body.length).to.be.greaterThan(0);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "36 - Get Merchant Products",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Get all products across all invoices for this merchant.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}/products",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}",
                "products"
              ]
            }
          }
        },
        {
          "name": "37 - Remove Invoice from Merchant",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Disassociate an invoice from the merchant.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}",
                "invoices"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"invoiceIdentifiers\": [\"{{invoiceIdentifier}}\"]\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          }
        }
      ]
    },
    {
      "name": "Cleanup",
      "description": "Cleanup test data",
      "item": [
        {
          "name": "38 - Delete Merchant",
          "request": {
            "method": "DELETE",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Delete the test merchant. Expected: 204 No Content.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/merchants/{{merchantIdentifier}}?parentCompanyId=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "merchants",
                "{{merchantIdentifier}}"
              ],
              "query": [
                {
                  "key": "parentCompanyId",
                  "value": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
                }
              ]
            }
          }
        },
        {
          "name": "39 - Delete Invoice",
          "request": {
            "method": "DELETE",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Delete the test invoice. Expected: 204 No Content.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices/{{invoiceIdentifier}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices",
                "{{invoiceIdentifier}}"
              ]
            }
          }
        },
        {
          "name": "40 - Verify Cleanup (Get All Invoices)",
          "request": {
            "method": "GET",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Verify the invoice was deleted.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices"
              ]
            }
          }
        },
        {
          "name": "41 - Delete All Invoices (Bulk)",
          "request": {
            "method": "DELETE",
            "header": [],
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{authToken}}",
                  "type": "string"
                }
              ]
            },
            "description": "Delete all invoices for the authenticated user. Expected: 204 No Content. Use with caution - this deletes ALL user invoices.",
            "url": {
              "raw": "{{baseUrl}}/rest/v1/invoices",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "rest",
                "v1",
                "invoices"
              ]
            }
          }
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "invoiceIdentifier",
      "value": "",
      "type": "string"
    },
    {
      "key": "merchantIdentifier",
      "value": "",
      "type": "string"
    },
    {
      "key": "userIdentifier",
      "value": "fafa1779-d0d9-4442-bba6-cbf0e2bf6d7a",
      "type": "string"
    },
    {
      "key": "authToken",
      "value": "",
      "type": "string",
      "description": "JWT Bearer token - inject via environment or manually"
    },
    {
      "key": "baseUrl",
      "value": "https://api.arolariu.ro",
      "type": "string"
    }
  ]
}
