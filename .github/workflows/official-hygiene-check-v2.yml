---
# =============================================================================
# Code Hygiene Check Workflow (v2)
# =============================================================================
# This workflow performs comprehensive code quality checks on pull requests.
#
# Architecture:
#   - Phase 1: Setup & Change Detection
#   - Phase 2: Parallel Quality Checks (each uploads JSON artifact)
#     - Format Check â†’ format-result.json
#     - Lint Check â†’ lint-result.json
#     - Unit Tests â†’ test-result.json
#     - Stats â†’ stats-result.json
#   - Phase 3: Summary (downloads all artifacts, posts rich PR comment)
#
# Data Flow:
#   - Each check job produces a {check}-result.json artifact
#   - Summary job downloads all artifacts in parallel
#   - Comment builder consumes artifacts to generate rich PR comment
#   - New comment created on each run (no update logic)
#
# Quality Gates:
#   - Formatting: Must pass Prettier check
#   - Linting: Must pass ESLint with strict TypeScript rules
#   - Testing: All unit tests must pass
#   - Bundle Size: Tracked for regression detection (vs main)
#
# Artifacts:
#   - retention-days: 1 (ephemeral, only needed for summary job)
#   - Pattern: artifacts/hygiene/{check}-result.json
#
# Local Resolution:
#   - Format: npm run format
#   - Lint: npm run lint
#   - Tests: npm run test:unit
# =============================================================================

name: "Code Hygiene Check"

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

  workflow_dispatch:

concurrency:
  group: hygiene-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "24"
  HEAD_REF: ${{ github.event.pull_request.head.sha || github.sha }}
  BASE_REF: ${{ github.event.pull_request.base.sha || 'origin/main' }}

jobs:
  # ============================================================================
  # SETUP & CHANGE DETECTION
  # ============================================================================
  setup:
    name: ğŸ§© Setup & Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-changes: ${{ steps.detect.outputs.has-changes }}
      changed-files-count: ${{ steps.detect.outputs.changed-files-count }}
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'
          install-node-dependencies: 'true'

      - name: ğŸ” Detect changes
        id: detect
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "detect"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const { default: runHygieneCheck } = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheckV2.ts');
            await runHygieneCheck();

  # ============================================================================
  # FORMAT CHECK
  # ============================================================================
  format:
    name: ğŸ¨ Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    continue-on-error: true
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ¨ Run format check
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "format"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const { default: runHygieneCheck } = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheckV2.ts');
            await runHygieneCheck();

      - name: ğŸ“¤ Upload format result
        uses: actions/upload-artifact@v6
        with:
          name: format-result
          path: artifacts/hygiene/format-result.json
          retention-days: 1

  # ============================================================================
  # LINT CHECK
  # ============================================================================
  lint:
    name: ğŸ” Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    continue-on-error: true
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ” Run lint check
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "lint"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const { default: runHygieneCheck } = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheckV2.ts');
            await runHygieneCheck();

      - name: ğŸ“¤ Upload lint result
        uses: actions/upload-artifact@v6
        with:
          name: lint-result
          path: artifacts/hygiene/lint-result.json
          retention-days: 1

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    continue-on-error: true
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ”¨ Build components package
        run: npm run build:components

      - name: ğŸ§ª Run test check
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "test"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const { default: runHygieneCheck } = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheckV2.ts');
            await runHygieneCheck();

      - name: ğŸ“¤ Upload test result
        uses: actions/upload-artifact@v6
        with:
          name: test-result
          path: |
            artifacts/hygiene/test-result.json
            artifacts/vitest-output.json
            coverage/vitest/coverage-summary.json
          retention-days: 1

  # ============================================================================
  # CODE STATISTICS & BUNDLE ANALYSIS
  # ============================================================================
  stats:
    name: ğŸ“Š Code Statistics
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    continue-on-error: true
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ“Š Compute statistics
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "stats"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const { default: runHygieneCheck } = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheckV2.ts');
            await runHygieneCheck();

      - name: ğŸ“¤ Upload stats result
        uses: actions/upload-artifact@v6
        with:
          name: stats-result
          path: artifacts/hygiene/stats-result.json
          retention-days: 1

  # ============================================================================
  # SUMMARY & PR COMMENT
  # ============================================================================
  summary:
    name: ğŸ“‹ Summary & PR Comment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [setup, format, lint, test, stats]
    if: always() && (needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch')
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/hygiene
          pattern: "*-result"
          merge-multiple: true

      - name: ğŸ“‹ Generate summary and post comment
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHECK_MODE: "summary"
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const { default: runHygieneCheck } = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheckV2.ts');
            await runHygieneCheck();

      - name: ğŸ¯ Determine final status
        run: |
          # Check if any of the check jobs failed (not continue-on-error failures)
          FORMAT_STATUS="${{ needs.format.result }}"
          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.test.result }}"
          STATS_STATUS="${{ needs.stats.result }}"

          echo "Format: $FORMAT_STATUS"
          echo "Lint: $LINT_STATUS"
          echo "Test: $TEST_STATUS"
          echo "Stats: $STATS_STATUS"

          # The actual pass/fail is determined by the artifacts
          # This just logs the job-level results
          echo "âœ… Summary job completed. See PR comment for detailed results."
