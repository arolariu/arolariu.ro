# =============================================================================
# Documentation Website Build and Deployment Workflow
# =============================================================================
# This workflow generates and deploys the API documentation website
# (docs.arolariu.ro) using DocFX for .NET API reference documentation.
#
# Architecture:
#   - DocFX Metadata: Extracts XML documentation from .NET assemblies
#   - DocFX Build: Generates static HTML documentation
#   - Azure Static Web Apps: Hosts the generated documentation
#
# Triggers:
#   - Automatic: Push to 'main' branch (excluding .github/ changes)
#   - Manual: workflow_dispatch for on-demand documentation regeneration
#
# Technology Stack:
#   - DocFX: .NET API documentation generator
#   - .NET 10.0: Required for building and analyzing assemblies
#   - Azure Static Web Apps: Global CDN hosting
#
# Security:
#   - Uses OIDC for Azure authentication
#   - Static Web Apps deployment token stored in GitHub Secrets
#
# Prerequisites:
#   1. DocFX configuration in sites/docs.arolariu.ro/docfx.json
#   2. .NET solution with XML documentation enabled
#   3. GitHub Secrets configured:
#      - AZURE_STATIC_WEB_APPS_DOCS_TOKEN
#
# Output:
#   - URL: https://docs.arolariu.ro
#   - Content: Auto-generated API reference from C# XML comments
# =============================================================================

name: "official-docs-trigger"

permissions:
  id-token: write # Required for OIDC authentication with Azure
  contents: read # Required to checkout repository

on:
  # Automatic trigger on main branch changes (except .github/)
  push:
    branches: ["main"]
    paths-ignore: [".github/*"]

  # Manual trigger for on-demand documentation regeneration
  workflow_dispatch:

env:
  COMMIT_SHA: ${{ github.sha }}

jobs:
  build-and-deploy:
    if: github.repository == 'arolariu/arolariu.ro'
    name: üöÄ Building and deploying the docs platform (docs.arolariu.ro)...
    runs-on: ubuntu-latest
    environment:
      name: "documentation"
      url: "https://docs.arolariu.ro"
    steps:
      - name: üõ´ Checking out the branch inside the runner environment...
        uses: actions/checkout@v6

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          dotnet-version: '10'
          install-node-dependencies: 'true'
          install-dotnet-dependencies: 'true'
          cache-key-prefix: 'docs'

      - name: "[DOCS::1/4] üèóÔ∏è Installing the .NET dependencies..."
        run: |
          dotnet workload restore
          dotnet restore ./arolariu.slnx

      - name: "[DOCS::2/4] üßæ Generating TypeScript API reference (TypeDoc)..."
        run: npm run docs:typedoc

      - name: "[DOCS::3/4] ‚öôÔ∏è Building the DocFX documentation platform..."
        run: |
          dotnet tool update -g docfx
          docfx metadata "./sites/docs.arolariu.ro/docfx.json"
          docfx build "./sites/docs.arolariu.ro/docfx.json"

      - name: "[DOCS::4/4] üöÄ Deploying documentation..."
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_DOCS_TOKEN }}
          action: "upload"
          app_location: "./sites/docs.arolariu.ro/_site" # App source code path
          output_location: "./sites/docs.arolariu.ro/_site"
