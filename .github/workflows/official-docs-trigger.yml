name: "official-docs-trigger"

permissions:
  id-token: write
  contents: read

on:
  push:
    branches: ["main"]
    paths-ignore: [".github/*"]
  workflow_dispatch:

env:
  COMMIT_SHA: ${{ github.sha }}

jobs:
  build-and-deploy:
    if: github.repository == 'arolariu/arolariu.ro'
    name: ğŸš€ Building and deploying the docs platform (docs.arolariu.ro)...
    runs-on: ubuntu-latest
    environment:
      name: "documentation"
      url: "https://docs.arolariu.ro"
    steps:
      - name: ğŸ›« Checking out the branch inside the runner environment...
        uses: actions/checkout@v6

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          dotnet-version: '10'
          install-node-dependencies: 'false'
          install-dotnet-dependencies: 'true'
          cache-key-prefix: 'docs'

      - name: "[API::1/3] ğŸ—ï¸ Installing the API dependencies..."
        run: |
          dotnet workload restore
          dotnet restore ./arolariu.slnx

      - name: "[API::2/3] âš™ï¸ Starting setup for the DocFX documentation platform..."
        run: |
          dotnet tool update -g docfx
          docfx metadata "./sites/docs.arolariu.ro/docfx.json"
          docfx build "./sites/docs.arolariu.ro/docfx.json"

      - name: "[API::3/3] ğŸš€ Deploying API documentation..."
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_DOCS_TOKEN }}
          action: "upload"
          app_location: "./sites/docs.arolariu.ro/_site" # App source code path
          output_location: "./sites/docs.arolariu.ro/_site"
