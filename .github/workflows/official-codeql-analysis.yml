name: "CodeQL Security Analysis"

# =============================================================================
# CodeQL Security Analysis Workflow
# =============================================================================
# This workflow performs semantic code analysis using GitHub CodeQL to identify
# security vulnerabilities and code quality issues across the monorepo.
#
# Supported Languages:
#   - JavaScript/TypeScript (Next.js, SvelteKit, Node.js)
#   - C# (.NET Backend API)
#
# Analysis Triggers:
#   - Push to main/preview branches
#   - Pull requests targeting main/preview
#   - Weekly scheduled scans (Sundays at 00:00 UTC)
#   - Manual workflow dispatch
# =============================================================================

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: read

on:
  push:
    branches: ["main", "preview"]
    paths:
      - "**.js"
      - "**.jsx"
      - "**.ts"
      - "**.tsx"
      - "**.cs"
      - "**.csproj"
      - "**.sln"
      - ".github/workflows/official-codeql-analysis.yml"
  pull_request:
    branches: ["main", "preview"]
    paths:
      - "**.js"
      - "**.jsx"
      - "**.ts"
      - "**.tsx"
      - "**.cs"
      - "**.csproj"
      - "**.sln"
  schedule:
    # Run weekly on Sundays at 00:00 UTC for comprehensive security scans
    - cron: "0 0 * * 0"
  workflow_dispatch:
    inputs:
      languages:
        description: "Languages to analyze (comma-separated: javascript-typescript,csharp)"
        required: false
        default: "javascript-typescript,csharp"
        type: string
      query-suite:
        description: "CodeQL query suite to use"
        required: false
        default: "security-and-quality"
        type: choice
        options:
          - "security-extended"
          - "security-and-quality"
          - "code-scanning"

concurrency:
  group: codeql-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "24"
  DOTNET_VERSION: "10.x"

jobs:
  # ============================================================================
  # JAVASCRIPT/TYPESCRIPT ANALYSIS
  # ============================================================================
  analyze-javascript:
    name: ğŸ” Analyze JavaScript/TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && (
        contains(github.event.head_commit.modified, '.js') ||
        contains(github.event.head_commit.modified, '.jsx') ||
        contains(github.event.head_commit.modified, '.ts') ||
        contains(github.event.head_commit.modified, '.tsx')
      )) ||
      github.event_name == 'pull_request'

    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: ğŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: ${{ inputs.query-suite || 'security-and-quality' }}
          config-file: .github/codeql/codeql-config.yml

      # JavaScript/TypeScript is interpreted, so no build step is required
      # CodeQL will automatically analyze the source files

      - name: ğŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"
          output: sarif-results
          upload: failure-only

      - name: ğŸ“¤ Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif-results
          category: "/language:javascript-typescript"

  # ============================================================================
  # C# / .NET ANALYSIS
  # ============================================================================
  analyze-csharp:
    name: ğŸ” Analyze C# / .NET
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && (
        contains(github.event.head_commit.modified, '.cs') ||
        contains(github.event.head_commit.modified, '.csproj')
      )) ||
      github.event_name == 'pull_request'

    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: ğŸ“¦ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          queries: ${{ inputs.query-suite || 'security-and-quality' }}
          config-file: .github/codeql/codeql-config.yml

      - name: ğŸ—ï¸ Build .NET Solution
        working-directory: ./sites/api.arolariu.ro
        run: |
          dotnet restore
          dotnet build --no-restore --configuration Release

      - name: ğŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"
          output: sarif-results
          upload: failure-only

      - name: ğŸ“¤ Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif-results
          category: "/language:csharp"

  # ============================================================================
  # ANALYSIS SUMMARY
  # ============================================================================
  summary:
    name: ğŸ“Š Security Analysis Summary
    runs-on: ubuntu-latest
    needs: [analyze-javascript, analyze-csharp]
    if: always()
    steps:
      - name: ğŸ“‹ Generate Summary
        uses: actions/github-script@v8
        with:
          script: |
            const jobs = ${{ toJSON(needs) }};

            const jsResult = jobs['analyze-javascript']?.result || 'skipped';
            const csResult = jobs['analyze-csharp']?.result || 'skipped';

            const getStatusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'âš ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };

            const summaryTable = `
            ## ğŸ” CodeQL Security Analysis Summary

            | Language | Status | Result |
            |----------|--------|--------|
            | JavaScript/TypeScript | ${getStatusEmoji(jsResult)} | ${jsResult} |
            | C# / .NET | ${getStatusEmoji(csResult)} | ${csResult} |

            ### ğŸ“ Notes
            - Security findings are available in the **Security** tab
            - Review and resolve any identified vulnerabilities
            - False positives can be dismissed with appropriate justification

            **Run ID:** \`${{ github.run_id }}\`
            **Triggered by:** \`${{ github.event_name }}\`
            **Branch:** \`${{ github.ref_name }}\`
            `;

            await core.summary
              .addRaw(summaryTable)
              .write();

            // Set workflow status
            const hasFailure = jsResult === 'failure' || csResult === 'failure';
            if (hasFailure) {
              core.setFailed('One or more CodeQL analyses failed. Check the Security tab for details.');
            }
