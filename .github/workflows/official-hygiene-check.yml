# =============================================================================
# Code Hygiene Check Workflow
# =============================================================================
# This workflow performs comprehensive code quality checks on pull requests,
# including formatting validation, linting, unit testing, and code statistics.
#
# Architecture:
#   - Phase 1: Setup & Change Detection - Identifies modified files
#   - Phase 2: Parallel Quality Checks:
#     - Format Check: Prettier formatting validation
#     - Lint Check: ESLint with 20+ plugins (strict mode)
#     - Unit Tests: Jest/Vitest test execution
#   - Phase 3: Code Statistics & Bundle Analysis
#   - Phase 4: Summary & PR Comment - Consolidated feedback
#
# Quality Gates:
#   - Formatting: Must pass Prettier check (auto-fixable locally)
#   - Linting: Must pass ESLint with strict TypeScript rules
#   - Testing: All unit tests must pass
#   - Bundle Size: Tracked for regression detection
#
# Triggers:
#   - Automatic: Pull request opened, synchronized, or reopened
#   - Manual: workflow_dispatch for on-demand hygiene checks
#
# Concurrency:
#   - Groups by PR number to avoid redundant runs
#   - Cancels in-progress runs when new commits are pushed
#
# PR Comment Features:
#   - Code statistics (files changed, lines added/deleted)
#   - Bundle size analysis with comparison to main
#   - Format/lint issues with actionable guidance
#   - Test results summary
#
# Prerequisites:
#   1. ESLint configuration (eslint.config.ts)
#   2. Prettier configuration (prettier.config.ts)
#   3. Vitest/Jest test configuration
#   4. Custom hygiene scripts in .github/scripts/hygiene/
#
# Local Resolution:
#   - Format: npm run format
#   - Lint: npm run lint -- --fix
#   - Tests: npm run test:unit
# =============================================================================

name: "Code Hygiene Check"

permissions:
  contents: read # Required to checkout repository and read files
  pull-requests: write # Required to post PR comments with results

on:
  # Automatic trigger on pull request activity
  pull_request:
    types: [opened, synchronize, reopened]

  # Manual trigger for on-demand hygiene checks
  workflow_dispatch:

# Prevent redundant runs - cancel in-progress when new commits arrive
concurrency:
  group: hygiene-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "24"
  COMMIT_SHA: ${{ github.sha }}
  BASE_REF: ${{ github.event.pull_request.base.sha || github.event.before || 'origin/main' }}
  HEAD_REF: ${{ github.event.pull_request.head.sha || github.sha }}

jobs:
  # ============================================================================
  # SETUP & CHANGE DETECTION
  # ============================================================================
  setup:
    name: ğŸ§© Setup & Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-changes: ${{ steps.detect.outputs.has-changes }}
      changed-files: ${{ steps.detect.outputs.changed-files }}
      changed-files-count: ${{ steps.detect.outputs.changed-files-count }}
    steps:
      - name: ğŸ›« Checking out the repository...
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for accurate diff analysis
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'
          install-node-dependencies: 'true'

      - name: ğŸ” Detecting changes...
        id: detect
        uses: actions/github-script@v8
        env:
          BASE_REF: ${{ env.BASE_REF }}
          HEAD_REF: ${{ env.HEAD_REF }}
          CHECK_MODE: "detect"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

  # ============================================================================
  # PARALLEL QUALITY CHECKS
  # ============================================================================
  format:
    name: ğŸ¨ Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      format-needed: ${{ steps.check.outputs.format-needed }}
      files-needing-format: ${{ steps.check.outputs.files-needing-format }}
    steps:
      - name: ğŸ›« Checking out the repository...
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setting up the workspace...
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ¨ Checking the formatting...
        id: check
        run: ./.github/scripts/hygiene/check-format.sh

  lint:
    name: ğŸ” Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      lint-passed: ${{ steps.lint.outputs.lint-passed }}
      lint-output: ${{ steps.lint.outputs.lint-output }}
    steps:
      - name: ğŸ›« Checking out the repository...
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setting up the workspace...
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ” Checking the linting...
        id: lint
        run: ./.github/scripts/hygiene/check-lint.sh

  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ›« Checking out the repository...
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setting up the workspace...
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ”¨ Building @arolariu/components package...
        run: npm run build:components

      - name: ğŸ§ª Running unit tests...
        id: test
        run: ./.github/scripts/hygiene/check-unit-tests.sh

  # ============================================================================
  # CODE STATISTICS & BUNDLE SIZE ANALYSIS
  # ============================================================================
  stats:
    name: ğŸ“Š Code Statistics & Bundle Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      files-changed: ${{ steps.stats.outputs.files-changed }}
      lines-added: ${{ steps.stats.outputs.lines-added }}
      lines-deleted: ${{ steps.stats.outputs.lines-deleted }}
      files-changed-vs-prev: ${{ steps.stats.outputs.files-changed-vs-prev }}
      lines-added-vs-prev: ${{ steps.stats.outputs.lines-added-vs-prev }}
      lines-deleted-vs-prev: ${{ steps.stats.outputs.lines-deleted-vs-prev }}
      is-first-commit: ${{ steps.stats.outputs.is-first-commit }}
      bundle-size-markdown: ${{ steps.stats.outputs.bundle-size-markdown }}
      top-ext-markdown: ${{ steps.extra-stats.outputs.top-ext-markdown }}
      top-dir-markdown: ${{ steps.extra-stats.outputs.top-dir-markdown }}
      churn: ${{ steps.extra-stats.outputs.churn }}
      net-change: ${{ steps.extra-stats.outputs.net-change }}
    steps:
      - name: ğŸ›« Checking out the repository...
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for bundle comparison
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setting up the workspace...
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'

      - name: ğŸ“Š Computing statistics...
        id: stats
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "stats"
          HEAD_REF: ${{ env.HEAD_REF }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

      - name: ğŸ“ˆ Extended diff metrics
        id: extra-stats
        run: ./.github/scripts/hygiene/compute-extra-stats.sh "origin/main" "${{ env.HEAD_REF }}"

  # ============================================================================
  # CONSOLIDATED SUMMARY & REPORTING
  # ============================================================================
  summary:
    name: ğŸ“‹ Summary & PR Comment
    runs-on: ubuntu-latest
    needs: [setup, format, lint, test, stats]
    if: always()
    steps:
      - name: ğŸ›« Checking out the repository...
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: ğŸ“¦ Setting up the workspace...
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-${{ github.event.pull_request.number || github.run_id }}'
          install-node-dependencies: 'false'

      - name: ğŸ’¬ Post hygiene comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Job results
          STATS_RESULT: ${{ needs.stats.result }}
          # Core statistics from stats job
          FILES_CHANGED: ${{ needs.stats.outputs.files-changed }}
          LINES_ADDED: ${{ needs.stats.outputs.lines-added }}
          LINES_DELETED: ${{ needs.stats.outputs.lines-deleted }}
          FILES_CHANGED_VS_PREV: ${{ needs.stats.outputs.files-changed-vs-prev }}
          LINES_ADDED_VS_PREV: ${{ needs.stats.outputs.lines-added-vs-prev }}
          LINES_DELETED_VS_PREV: ${{ needs.stats.outputs.lines-deleted-vs-prev }}
          IS_FIRST_COMMIT: ${{ needs.stats.outputs.is-first-commit }}
          BUNDLE_SIZE_MARKDOWN: ${{ needs.stats.outputs.bundle-size-markdown }}
          # Extended metrics
          TOP_EXTENSION_TABLE: ${{ needs.stats.outputs.top-ext-markdown }}
          TOP_DIRECTORY_TABLE: ${{ needs.stats.outputs.top-dir-markdown }}
          CHURN: ${{ needs.stats.outputs.churn }}
          NET_CHANGE: ${{ needs.stats.outputs.net-change }}
          # Formatting
          FORMAT_NEEDED: ${{ needs.format.outputs.format-needed }}
          FILES_NEEDING_FORMAT: ${{ needs.format.outputs.files-needing-format }}
          # Linting
          LINT_PASSED: ${{ needs.lint.outputs.lint-passed }}
          LINT_OUTPUT: ${{ needs.lint.outputs.lint-output }}
          # Workflow context
          CHECK_MODE: "comment"
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

      - name: âœ… Success check
        if: needs.format.outputs.format-needed == 'false' && needs.lint.outputs.lint-passed == 'true' && needs.test.result == 'success'
        run: echo "ğŸ‰ All hygiene checks passed!"

      - name: âŒ Failure check
        if: needs.format.outputs.format-needed == 'true' || needs.lint.outputs.lint-passed == 'false' || needs.test.result != 'success'
        run: |
          echo "::error::Code hygiene checks failed. See PR comment for details."
          exit 1
