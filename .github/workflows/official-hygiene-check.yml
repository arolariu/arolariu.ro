name: "Code Hygiene Check"

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: hygiene-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "24"
  COMMIT_SHA: ${{ github.sha }}
  BASE_REF: ${{ github.event.pull_request.base.sha || github.event.before || 'origin/main' }}
  HEAD_REF: ${{ github.event.pull_request.head.sha || github.sha }}

jobs:
  # ============================================================================
  # SETUP & CHANGE DETECTION
  # ============================================================================
  setup:
    name: üß© Setup & Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-changes: ${{ steps.detect.outputs.has-changes }}
      changed-files: ${{ steps.detect.outputs.changed-files }}
      changed-files-count: ${{ steps.detect.outputs.changed-files-count }}
    steps:
      - name: üõ´ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history for accurate diff analysis
          ref: ${{ env.HEAD_REF }}

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-setup'
          install-node-dependencies: 'false' # Scripts dir will install its own deps

      - name: üîé Detect changes
        id: detect
        uses: actions/github-script@v8
        env:
          BASE_REF: ${{ env.BASE_REF }}
          HEAD_REF: ${{ env.HEAD_REF }}
          CHECK_MODE: "detect"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

  # ============================================================================
  # PARALLEL QUALITY CHECKS
  # ============================================================================
  format:
    name: üé® Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      format-needed: ${{ steps.check.outputs.format-needed }}
      files-needing-format: ${{ steps.check.outputs.files-needing-format }}
    steps:
      - name: üõ´ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-format'

      - name: üé® Run Prettier
        run: npm run format

      - name: üîç Check for changes
        id: check
        run: |
          DIFF="$(git diff --name-only || true)"
          if [ -n "$DIFF" ]; then
            echo "format-needed=true" >> "$GITHUB_OUTPUT"
            echo "files-needing-format=$(echo "$DIFF" | paste -sd, -)" >> "$GITHUB_OUTPUT"
            echo "‚ùå Files need formatting:"
            echo "$DIFF"
            git --no-pager diff
            exit 1
          else
            echo "format-needed=false" >> "$GITHUB_OUTPUT"
            echo "files-needing-format=" >> "$GITHUB_OUTPUT"
            echo "‚úÖ All files properly formatted"
          fi

  lint:
    name: üîç Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      lint-passed: ${{ steps.lint.outputs.lint-passed }}
      lint-output: ${{ steps.lint.outputs.lint-output }}
    steps:
      - name: üõ´ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-lint'

      - name: üîç Run ESLint
        id: lint
        run: |
          set +e
          npm run lint > lint_output.txt 2>&1
          EXIT_CODE=$?
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "lint-passed=true" >> "$GITHUB_OUTPUT"
            echo "lint-output=All checks passed!" >> "$GITHUB_OUTPUT"
          else
            echo "lint-passed=false" >> "$GITHUB_OUTPUT"
            TRUNCATED_CONTENT="$(head -c 50000 lint_output.txt)"
            {
              echo "lint-output<<EOF"
              echo "$TRUNCATED_CONTENT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 1
          fi

  test:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      test-result: ${{ steps.test.outputs.result }}
    steps:
      - name: üõ´ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-test'

      - name: üß™ Run unit tests
        id: test
        run: |
          npm run test:unit
          echo "result=success" >> "$GITHUB_OUTPUT"

  # ============================================================================
  # CODE STATISTICS & BUNDLE SIZE ANALYSIS
  # ============================================================================
  stats:
    name: üìä Code Statistics & Bundle Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      files-changed: ${{ steps.stats.outputs.files-changed }}
      lines-added: ${{ steps.stats.outputs.lines-added }}
      lines-deleted: ${{ steps.stats.outputs.lines-deleted }}
      files-changed-vs-prev: ${{ steps.stats.outputs.files-changed-vs-prev }}
      lines-added-vs-prev: ${{ steps.stats.outputs.lines-added-vs-prev }}
      lines-deleted-vs-prev: ${{ steps.stats.outputs.lines-deleted-vs-prev }}
      is-first-commit: ${{ steps.stats.outputs.is-first-commit }}
      bundle-size-markdown: ${{ steps.stats.outputs.bundle-size-markdown }}
      top-ext-markdown: ${{ steps.extra-stats.outputs.top-ext-markdown }}
      top-dir-markdown: ${{ steps.extra-stats.outputs.top-dir-markdown }}
      churn: ${{ steps.extra-stats.outputs.churn }}
      net-change: ${{ steps.extra-stats.outputs.net-change }}
    steps:
      - name: üõ´ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history for bundle comparison
          ref: ${{ env.HEAD_REF }}

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-stats'

      - name: üìä Compute statistics
        id: stats
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "stats"
          HEAD_REF: ${{ env.HEAD_REF }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

      - name: üìà Extended diff metrics
        id: extra-stats
        run: |
          set -e
          BASE_BRANCH="origin/main"
          TARGET_REF="${{ env.HEAD_REF }}"

          echo "Generating extended diff metrics vs $BASE_BRANCH...$TARGET_REF"
          git diff --name-only "$BASE_BRANCH"..."$TARGET_REF" > changed_files.txt || true

          if [ ! -s changed_files.txt ]; then
            echo "No changed files for extended stats."
            echo "top-ext-markdown=| Ext | Files |\n|-----|-------|\n" >> "$GITHUB_OUTPUT"
            echo "top-dir-markdown=| Directory | Files |\n|-----------|-------|\n" >> "$GITHUB_OUTPUT"
            echo "churn=0" >> "$GITHUB_OUTPUT"
            echo "net-change=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Compute churn & net-change
          git diff --numstat "$BASE_BRANCH"..."$TARGET_REF" > numstat.txt || true
          ADD=$(awk '{a+=$1} END {print a+0}' numstat.txt)
          DEL=$(awk '{d+=$2} END {print d+0}' numstat.txt)
          CHURN=$(( ADD + DEL ))
          NET=$(( ADD - DEL ))

          # Top extensions
          awk -F. '{
            if (NF==1) ext="(noext)";
            else ext=$NF;
            count[ext]++
          } END {
            for (e in count) print count[e], e
          }' changed_files.txt | sort -nr | head -5 > top_ext.txt

          # Top directories
          awk -F/ '{
            d=$1;
            if (d=="." || d=="") d="(root)";
            count[d]++
          } END {
            for (d in count) print count[d], d
          }' changed_files.txt | sort -nr | head -5 > top_dir.txt

          {
            echo '| Ext | Files |'
            echo '|-----|-------|'
            awk '{print "| " $2 " | " $1 " |"}' top_ext.txt
          } > top_ext.md

          {
            echo '| Directory | Files |'
            echo '|-----------|-------|'
            awk '{print "| " $2 " | " $1 " |"}' top_dir.txt
          } > top_dir.md

          {
            echo "top-ext-markdown<<EOF"
            cat top_ext.md
            echo "EOF"
            echo "top-dir-markdown<<EOF"
            cat top_dir.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "churn=$CHURN" >> "$GITHUB_OUTPUT"
          echo "net-change=$NET" >> "$GITHUB_OUTPUT"

  # ============================================================================
  # CONSOLIDATED SUMMARY & REPORTING
  # ============================================================================
  summary:
    name: üìã Summary & PR Comment
    runs-on: ubuntu-latest
    needs: [setup, format, lint, test, stats]
    if: always()
    steps:
      - name: üõ´ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: üì¶ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-summary'
          install-node-dependencies: 'false'

      - name: üí¨ Post hygiene comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Job results
          STATS_RESULT: ${{ needs.stats.result }}
          FORMATTING_RESULT: ${{ needs.format.result == 'success' && 'success' || 'failure' }}
          LINTING_RESULT: ${{ needs.lint.result }}
          # Core statistics from stats job
          FILES_CHANGED: ${{ needs.stats.outputs.files-changed }}
          LINES_ADDED: ${{ needs.stats.outputs.lines-added }}
          LINES_DELETED: ${{ needs.stats.outputs.lines-deleted }}
          FILES_CHANGED_VS_PREV: ${{ needs.stats.outputs.files-changed-vs-prev }}
          LINES_ADDED_VS_PREV: ${{ needs.stats.outputs.lines-added-vs-prev }}
          LINES_DELETED_VS_PREV: ${{ needs.stats.outputs.lines-deleted-vs-prev }}
          IS_FIRST_COMMIT: ${{ needs.stats.outputs.is-first-commit }}
          BUNDLE_SIZE_MARKDOWN: ${{ needs.stats.outputs.bundle-size-markdown }}
          # Extended metrics
          TOP_EXTENSION_TABLE: ${{ needs.stats.outputs.top-ext-markdown }}
          TOP_DIRECTORY_TABLE: ${{ needs.stats.outputs.top-dir-markdown }}
          CHURN: ${{ needs.stats.outputs.churn }}
          NET_CHANGE: ${{ needs.stats.outputs.net-change }}
          # Formatting
          FORMAT_NEEDED: ${{ needs.format.outputs.format-needed }}
          FILES_NEEDING_FORMAT: ${{ needs.format.outputs.files-needing-format }}
          # Linting
          LINT_PASSED: ${{ needs.lint.outputs.lint-passed }}
          LINT_OUTPUT: ${{ needs.lint.outputs.lint-output }}
          # Workflow context
          CHECK_MODE: "comment"
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

      - name: ‚úÖ Success check
        if: needs.format.outputs.format-needed == 'false' && needs.lint.outputs.lint-passed == 'true' && needs.test.result == 'success'
        run: echo "üéâ All hygiene checks passed!"

      - name: ‚ùå Failure check
        if: needs.format.outputs.format-needed == 'true' || needs.lint.outputs.lint-passed == 'false' || needs.test.result != 'success'
        run: |
          echo "::error::Code hygiene checks failed. See PR comment for details."
          exit 1
