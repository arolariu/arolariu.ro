name: "Code Hygiene Check"

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: hygiene-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "24"
  COMMIT_SHA: ${{ github.sha }}
  BASE_REF: ${{ github.event.pull_request.base.sha || github.event.before || 'origin/main' }}
  HEAD_REF: ${{ github.event.pull_request.head.sha || github.sha }}

jobs:
  # ============================================================================
  # SETUP & CHANGE DETECTION
  # ============================================================================
  setup:
    name: ğŸ§© Setup & Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-changes: ${{ steps.detect.outputs.has-changes }}
      changed-files: ${{ steps.detect.outputs.changed-files }}
      changed-files-count: ${{ steps.detect.outputs.changed-files-count }}
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history for accurate diff analysis
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-setup'
          install-node-dependencies: 'false' # Scripts dir will install its own deps

      - name: ğŸ” Detect changes
        id: detect
        uses: actions/github-script@v8
        env:
          BASE_REF: ${{ env.BASE_REF }}
          HEAD_REF: ${{ env.HEAD_REF }}
          CHECK_MODE: "detect"
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

  # ============================================================================
  # PARALLEL QUALITY CHECKS
  # ============================================================================
  format:
    name: ğŸ¨ Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ›« Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-format'

      - name: ğŸ¨ Run Prettier
        run: npm run format

      - name: ğŸ” Check for changes
        id: check
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "format-needed=true" >> "$GITHUB_OUTPUT"
            echo "âŒ Files need formatting:"
            git --no-pager diff --name-only
            git --no-pager diff
            exit 1
          else
            echo "format-needed=false" >> "$GITHUB_OUTPUT"
            echo "âœ… All files properly formatted"
          fi

  lint:
    name: ğŸ” Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ›« Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-lint'

      - name: ğŸ” Run ESLint
        run: npm run lint

  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ›« Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-test'

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit

  # ============================================================================
  # CODE STATISTICS & BUNDLE SIZE ANALYSIS
  # ============================================================================
  stats:
    name: ğŸ“Š Code Statistics & Bundle Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: setup
    if: needs.setup.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      stats-result: ${{ steps.stats.outputs.result }}
    steps:
      - name: ğŸ›« Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history for bundle comparison
          ref: ${{ env.HEAD_REF }}

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-stats'

      - name: ğŸ“Š Compute statistics
        id: stats
        uses: actions/github-script@v8
        env:
          CHECK_MODE: "stats"
          HEAD_REF: ${{ env.HEAD_REF }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

  # ============================================================================
  # CONSOLIDATED SUMMARY & REPORTING
  # ============================================================================
  summary:
    name: ğŸ“‹ Summary & PR Comment
    runs-on: ubuntu-latest
    needs: [setup, format, lint, test, stats]
    if: always()
    steps:
      - name: ğŸ›« Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-key-prefix: 'hygiene-summary'
          install-node-dependencies: 'false'

      - name: ğŸ’¬ Post hygiene comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Job results
          FORMAT_RESULT: ${{ needs.format.result }}
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
          STATS_RESULT: ${{ needs.stats.result }}
          # Derive formatting status
          FORMATTING_RESULT: ${{ needs.format.result == 'success' && 'success' || 'failure' }}
          LINTING_RESULT: ${{ needs.lint.result }}
          # Statistics output (will be populated by stats job via setOutput)
          CHECK_MODE: "comment"
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('cd .github/scripts && npm ci', { stdio: 'inherit' });
            const {default: runHygieneCheck} = await import('${{ github.workspace }}/.github/scripts/src/runHygieneCheck.ts');
            await runHygieneCheck();

      - name: âœ… Success check
        if: needs.format.result == 'success' && needs.lint.result == 'success' && needs.test.result == 'success'
        run: echo "ğŸ‰ All hygiene checks passed!"

      - name: âŒ Failure check
        if: needs.format.result != 'success' || needs.lint.result != 'success' || needs.test.result != 'success'
        run: |
          echo "::error::Code hygiene checks failed. See PR comment for details."
          exit 1
