# =============================================================================
# NPM Package Publishing Workflow for @arolariu/components
# =============================================================================
# This workflow publishes the @arolariu/components package to npm registry
# using Trusted Publishing (OIDC) for secure, tokenless authentication.
#
# Features:
#   - Trusted Publishing via OIDC (no long-lived npm tokens required)
#   - Automatic provenance attestations for supply chain security
#   - Version validation before publish
#   - Comprehensive testing before release
#
# Prerequisites:
#   1. Configure Trusted Publisher on npmjs.com:
#      - Organization: arolariu
#      - Repository: arolariu.ro
#      - Workflow filename: official-components-publish.yml
#      - Environment name: npm-publish (optional but recommended)
#
# Documentation:
#   - https://docs.npmjs.com/trusted-publishers
#   - https://docs.npmjs.com/generating-provenance-statements
# =============================================================================

name: "official-components-publish"

permissions:
  id-token: write # Required for OIDC authentication with npm
  contents: read # Required to checkout repository
  attestations: write # Required for provenance attestations

on:
  # Manual trigger for controlled releases
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Perform a dry run (no actual publish)"
        required: false
        default: false
        type: boolean
      tag:
        description: "NPM distribution tag (e.g., 'latest', 'beta', 'next')"
        required: false
        default: "latest"
        type: choice
        options:
          - "latest"
          - "beta"
          - "next"
          - "canary"
  # Automatic trigger on version tag pushes
  push:
    tags:
      - "components-v*" # e.g., components-v0.3.2

defaults:
  run:
    working-directory: ./packages/components

env:
  NODE_VERSION: "24"
  PACKAGE_PATH: "packages/components"

jobs:
  # ===========================================================================
  # VALIDATION JOB
  # ===========================================================================
  # Validates the package before publishing
  validate:
    name: ğŸ” Validate Package
    runs-on: ubuntu-latest
    if: github.repository == 'arolariu/arolariu.ro'
    outputs:
      version: ${{ steps.package-info.outputs.version }}
      name: ${{ steps.package-info.outputs.name }}
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ env.NODE_VERSION }}
          dotnet-version: ""
          cache-key-prefix: "components"

      - name: ğŸ“‹ Extract package information
        id: package-info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          NAME=$(node -p "require('./package.json').name")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "::notice::Package: $NAME@$VERSION"

      - name: ğŸ” Check if version already published
        run: |
          VERSION="${{ steps.package-info.outputs.version }}"
          NAME="${{ steps.package-info.outputs.name }}"

          # Check if this version already exists on npm
          if npm view "$NAME@$VERSION" version 2>/dev/null; then
            echo "::error::Version $VERSION is already published on npm!"
            exit 1
          else
            echo "::notice::Version $VERSION is not yet published. Ready to proceed."
          fi

      - name: ğŸ—ï¸ Build package
        run: npm run build

      - name: ğŸ§ª Run tests
        run: npm run test --if-present

      - name: ğŸ“¦ Verify package contents
        run: npm pack --dry-run

  # ===========================================================================
  # PUBLISH JOB
  # ===========================================================================
  # Publishes the package to npm with trusted publishing
  publish:
    name: ğŸš€ Publish to npm
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: npm-publish
      url: https://www.npmjs.com/package/${{ needs.validate.outputs.name }}
    steps:
      - name: ğŸ›« Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js with npm registry
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"

      # Ensure npm CLI is new enough for trusted publishing (11.5.1+)
      - name: ğŸ”„ Update npm to latest
        run: npm install -g npm@latest

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        working-directory: .

      - name: ğŸ—ï¸ Build package
        run: npm run build

      - name: ğŸ“‹ Display package info
        run: |
          echo "ğŸ“¦ Publishing ${{ needs.validate.outputs.name }}@${{ needs.validate.outputs.version }}"
          echo "ğŸ“ Package contents:"
          npm pack --dry-run
          echo ""
          echo "ğŸ·ï¸ Distribution tag: ${{ inputs.tag || 'latest' }}"
          echo "ğŸ” Authentication: Trusted Publishing (OIDC)"

      - name: ğŸš€ Publish to npm (Dry Run)
        if: inputs.dry-run == true
        run: |
          echo "::notice::ğŸ” DRY RUN - Package would be published as:"
          echo "  Name: ${{ needs.validate.outputs.name }}"
          echo "  Version: ${{ needs.validate.outputs.version }}"
          echo "  Tag: ${{ inputs.tag || 'latest' }}"
          npm publish --dry-run --tag ${{ inputs.tag || 'latest' }}

      - name: ğŸš€ Publish to npm
        if: inputs.dry-run != true
        run: npm publish --provenance --tag ${{ inputs.tag || 'latest' }} --access public
        # Note: No NODE_AUTH_TOKEN needed - using Trusted Publishing (OIDC)
        # Provenance is now explicitly generated via --provenance flag

      - name: âœ… Publish confirmation
        if: inputs.dry-run != true
        run: |
          echo "::notice::âœ… Successfully published ${{ needs.validate.outputs.name }}@${{ needs.validate.outputs.version }}"
          echo ""
          echo "ğŸ“¦ View on npm: https://www.npmjs.com/package/${{ needs.validate.outputs.name }}"
          echo "ğŸ” Provenance: Automatically attached via Trusted Publishing"
          echo ""
          echo "To verify provenance, run:"
          echo "  npm audit signatures"
